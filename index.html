<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–ö–ª–∏–∫–µ—Ä ‚Äî –æ—Ñ—Ñ–ª–∞–π–Ω (—Å –∞–¥–º–∏–Ω–∫–æ–π, —Ä—ã–Ω–∫–æ–º, –∏–Ω–≤–µ–Ω—Ç–∞—Ä—ë–º)</title>
<style>
:root{
  --bg:#071223; --card:#0b1522; --accent:#3b82f6; --muted:#9bb0c8; --glass: rgba(255,255,255,0.03);
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,Segoe UI,Arial;background:linear-gradient(180deg,#05111a 0%,#071827 100%);color:#eaf6ff}
.wrap{max-width:980px;margin:20px auto;padding:18px}
header{display:flex;justify-content:space-between;align-items:center;gap:10px}
h1{margin:0;font-size:20px}
.card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
#game{display:flex;gap:18px;align-items:center;margin-top:16px}
#clickBox{width:220px;height:220px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:48px;cursor:pointer;background:linear-gradient(135deg,#0b1220,#082134);border:1px solid rgba(255,255,255,0.03)}
.stats{min-width:260px}
.big{font-size:40px;font-weight:700;margin:8px 0}
.muted{color:var(--muted);font-size:13px}
button{background:var(--accent);border:0;padding:8px 12px;border-radius:10px;color:#022;cursor:pointer}
.input{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
.row{display:flex;gap:10px;align-items:center}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:14px}
.market-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-top:10px}
.market-item{background:var(--glass);padding:10px;border-radius:10px;text-align:left}
.inventory-list{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.inv-item{background:rgba(255,255,255,0.02);padding:6px 8px;border-radius:8px;display:flex;gap:8px;align-items:center}
.admin-panel{margin-top:12px;padding:10px;background:#071424;border-radius:10px}
.leaderboard table{width:100%;border-collapse:collapse;margin-top:8px}
.leaderboard th, .leaderboard td{padding:6px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.03)}
.small{padding:6px 8px;font-size:13px;border-radius:8px}
.footer{margin-top:14px;color:var(--muted);font-size:13px}
@media (max-width:820px){#game{flex-direction:column}#clickBox{width:180px;height:180px}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>–ö–ª–∏–∫–µ—Ä</h1>
    <div class="row">
      <div id="userInfo" class="muted">–ù–µ –≤–æ—à–ª–∏</div>
      <button id="btnAuth" class="small">–í–æ–π—Ç–∏ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
      <button id="btnAdmin" class="small">–ê–¥–º–∏–Ω</button>
    </div>
  </header>

  <section class="card" id="mainCard">
    <div id="game">
      <div id="clickBox" title="–ö–ª–∏–∫–Ω–∏!">üñ±Ô∏è</div>
      <div class="stats">
        <div class="muted">–ö–ª–∏–∫–∏</div>
        <div id="count" class="big">0</div>
        <div class="muted">–ü—Ä–æ—Ñ–∏–ª—å: <span id="profileName">–ì–æ—Å—Ç—å</span> <span id="checkmark"></span> <span id="equipped"></span></div>
        <div style="margin-top:10px" class="row">
          <button id="btnAdd10" class="small">+10</button>
          <button id="btnReset" class="small">–°–±—Ä–æ—Å</button>
          <button id="btnSave" class="small">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>
    </div>

    <div class="grid2">
      <div class="card">
        <strong>–†—ã–Ω–æ–∫</strong>
        <div id="market" class="market-grid"></div>
      </div>

      <div class="card">
        <strong>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</strong>
        <div id="inventory" class="inventory-list"><span class="muted">–ü—É—Å—Ç–æ</span></div>
        <div style="margin-top:8px" class="row">
          <button id="btnUnequip" class="small">–°–Ω—è—Ç—å –º–µ–¥–∞–ª—å</button>
          <button id="btnExport" class="small">–≠–∫—Å–ø–æ—Ä—Ç –ø—Ä–æ—Ñ–∏–ª—è</button>
          <button id="btnImport" class="small">–ò–º–ø–æ—Ä—Ç –ø—Ä–æ—Ñ–∏–ª—è</button>
        </div>
      </div>
    </div>

    <div class="grid2" style="margin-top:12px">
      <div class="card leaderboard">
        <strong>–¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤ (–ª–æ–∫–∞–ª—å–Ω–æ)</strong>
        <div id="leadersWrap"><table><thead><tr><th>#</th><th>–ò–º—è</th><th>–ö–ª–∏–∫–∏</th></tr></thead><tbody id="leadersBody"></tbody></table></div>
      </div>

      <div class="card">
        <strong>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</strong>
        <div class="muted" style="margin-top:8px">
          –ò–≥—Ä–∞ —Ö—Ä–∞–Ω–∏—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ (localStorage). –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–¥–∞—Ç—å/–∑–∞–±—Ä–∞—Ç—å –≥–∞–ª–æ—á–∫—É, –¥–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–∫–∏ –∏ –≤—ã–¥–∞—Ç—å/–∑–∞–±—Ä–∞—Ç—å –º–µ–¥–∞–ª–∏ —É –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        </div>
      </div>
    </div>

    <div id="adminPanel" class="admin-panel" style="display:none;">
      <strong>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</strong>
      <div style="margin-top:8px" class="row">
        <select id="adminUserSelect" class="input"></select>
        <input id="adminAmount" class="input" placeholder="–ö–ª–∏–∫–∏ (–Ω–∞–ø—Ä. 100)" style="width:120px"/>
        <button id="adminAddClicks" class="small">–î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–∫–∏</button>
      </div>

      <div style="margin-top:8px" class="row">
        <select id="adminMedalSelect" class="input"></select>
        <button id="adminGiveMedal" class="small">–í—ã–¥–∞—Ç—å –º–µ–¥–∞–ª—å</button>
        <button id="adminRemoveMedal" class="small">–ó–∞–±—Ä–∞—Ç—å –º–µ–¥–∞–ª—å</button>
      </div>

      <div style="margin-top:8px" class="row">
        <button id="adminGiveCheck" class="small">–í—ã–¥–∞—Ç—å –≥–∞–ª–æ—á–∫—É</button>
        <button id="adminRemoveCheck" class="small">–ó–∞–±—Ä–∞—Ç—å –≥–∞–ª–æ—á–∫—É</button>
        <button id="adminClose" class="small">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>

    <div id="authPanel" class="admin-panel" style="display:none;">
      <strong>–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</strong>
      <div style="margin-top:8px" class="col">
        <input id="inpLogin" class="input" placeholder="–õ–æ–≥–∏–Ω"/>
        <input id="inpPass" type="password" class="input" placeholder="–ü–∞—Ä–æ–ª—å"/>
        <div style="margin-top:8px" class="row">
          <button id="doRegister" class="small">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
          <button id="doLogin" class="small">–í–æ–π—Ç–∏</button>
          <button id="closeAuth" class="small">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
        <div id="authMsg" class="muted" style="margin-top:8px"></div>
      </div>
    </div>

    <div class="footer">–ü–æ—Ä–æ–≥–æ–≤—ã–µ –∏–∫–æ–Ω–∫–∏: –∫–∞–∂–¥—ã–µ 100 –∫–ª–∏–∫–æ–≤ –º–µ–Ω—è–µ—Ç—Å—è –∏–∫–æ–Ω–∫–∞ (0..1000). –•—Ä–∞–Ω–∏–ª–∏—â–µ: localStorage.</div>
  </section>
</div>

<script>
/* ================== –ù–ê–°–¢–†–û–ô–ö–ò ================== */
// –ü–∞—Ä–æ–ª—å –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ (–º–µ–Ω—è–π –ø—Ä—è–º–æ –∑–¥–µ—Å—å)
const ADMIN_PASSWORD = "per82sik";

(function removeAdminUserOnce(){
  let users = JSON.parse(localStorage.getItem('clicker_users_v2') || '[]');
  const hadAdmin = users.some(u => u.login === 'admin');
  if(hadAdmin){
    users = users.filter(u => u.login !== 'admin');
    localStorage.setItem('clicker_users_v2', JSON.stringify(users));
    alert('–ê–∫–∫–∞—É–Ω—Ç admin —É–¥–∞–ª—ë–Ω');
  }
})();


// –ú–µ–¥–∞–ª–∏: 10 —à—Ç—É–∫ (–º–æ–∂–µ—à—å –º–µ–Ω—è—Ç—å —Ü–µ–Ω—ã, —ç–º–æ–¥–∑–∏, –Ω–∞–∑–≤–∞–Ω–∏—è)
const MEDALS = [
  {name:"–ë—Ä–æ–Ω–∑–∞", price:20, emoji:"ü•â"},
  {name:"–°–µ—Ä–µ–±—Ä–æ", price:40, emoji:"ü•à"},
  {name:"–ó–æ–ª–æ—Ç–æ", price:60, emoji:"ü•á"},
  {name:"–ü–ª–∞—Ç–∏–Ω–∞", price:80, emoji:"üèÖ"},
  {name:"–ê–ª–º–∞–∑", price:100, emoji:"üíé"},
  {name:"–†—É–±–∏–Ω", price:120, emoji:"‚ù§Ô∏è"},
  {name:"–ò–∑—É–º—Ä—É–¥", price:140, emoji:"üíö"},
  {name:"–°–∞–ø—Ñ–∏—Ä", price:160, emoji:"üíô"},
  {name:"–õ–µ–≥–µ–Ω–¥–∞", price:180, emoji:"üèÜ"},
  {name:"–õ–µ–≥–µ–Ω–¥–∞ 2", price:250, emoji:"üèÜ"}
];

// localStorage –∫–ª—é—á–∏
const LS_USERS = "clicker_users_v2";
const LS_SESSION = "clicker_session_v2";

/* ================== –£–¢–ò–õ–ò–¢–´ ================== */
function loadUsers(){ try{ return JSON.parse(localStorage.getItem(LS_USERS)||"[]") }catch(e){return []} }
function saveUsers(u){ localStorage.setItem(LS_USERS, JSON.stringify(u)) }
function saveSession(login){ localStorage.setItem(LS_SESSION, JSON.stringify({login})) }
function loadSession(){ try{ return JSON.parse(localStorage.getItem(LS_SESSION)||"null") }catch(e){return null} }
function findUser(login){ return loadUsers().find(u=>u.login===login) }
function updateUser(updated){ const users=loadUsers(); const idx=users.findIndex(u=>u.login===updated.login); if(idx>=0) users[idx]=updated; else users.push(updated); saveUsers(users) }

/* –ü—Ä–æ—Å—Ç–∞—è "—Å–æ–ª—å" –¥–ª—è –ø–∞—Ä–æ–ª—è ‚Äî –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º btoa, —ç—Ç–æ –Ω–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ, –Ω–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è */
function encodePass(p){ try{return btoa(p)}catch(e){return p} }
function decodePass(h){ try{return atob(h)}catch(e){return h} }

/* ================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø (–µ—Å–ª–∏ –ø—É—Å—Ç–æ, –¥–æ–±–∞–≤–∏–º –¥–µ–º–æ-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è) ================== */


/* ================== –≠–õ–ï–ú–ï–ù–¢–´ ================== */
const clickBox = document.getElementById("clickBox");
const countEl = document.getElementById("count");
const profileNameEl = document.getElementById("profileName");
const checkmarkEl = document.getElementById("checkmark");
const equippedEl = document.getElementById("equipped");
const userInfoEl = document.getElementById("userInfo");

const marketEl = document.getElementById("market");
const inventoryEl = document.getElementById("inventory");
const leadersBody = document.getElementById("leadersBody");

const btnAuth = document.getElementById("btnAuth");
const authPanel = document.getElementById("authPanel");
const inpLogin = document.getElementById("inpLogin");
const inpPass = document.getElementById("inpPass");
const doRegisterBtn = document.getElementById("doRegister");
const doLoginBtn = document.getElementById("doLogin");
const closeAuthBtn = document.getElementById("closeAuth");
const authMsg = document.getElementById("authMsg");

const btnAdmin = document.getElementById("btnAdmin");
const adminPanel = document.getElementById("adminPanel");
const adminClose = document.getElementById("adminClose");
const adminUserSelect = document.getElementById("adminUserSelect");
const adminMedalSelect = document.getElementById("adminMedalSelect");
const adminAddClicksBtn = document.getElementById("adminAddClicks");
const adminAmount = document.getElementById("adminAmount");
const adminGiveMedalBtn = document.getElementById("adminGiveMedal");
const adminRemoveMedalBtn = document.getElementById("adminRemoveMedal");
const adminGiveCheckBtn = document.getElementById("adminGiveCheck");
const adminRemoveCheckBtn = document.getElementById("adminRemoveCheck");

const btnAdd10 = document.getElementById("btnAdd10");
const btnReset = document.getElementById("btnReset");
const btnSave = document.getElementById("btnSave");
const btnUnequip = document.getElementById("btnUnequip");
const btnExport = document.getElementById("btnExport");
const btnImport = document.getElementById("btnImport");

/* ================== –°–ï–°–°–ò–Ø ================== */
let currentUser = null; // –æ–±—ä–µ–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–æ–≥–¥–∞ –≤–æ—à–ª–∏

function setCurrentUserByLogin(login){
  if(!login){ currentUser=null; saveSession(null); renderAll(); return; }
  const user = findUser(login);
  if(user){ currentUser = user; saveSession(login); } else { currentUser = null; }
  renderAll();
}

/* –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ ‚Äî –ø–æ–¥–≥—Ä—É–∑–∏–º —Å–µ—Å—Å–∏–∏ –µ—Å–ª–∏ –µ—Å—Ç—å */
(function restoreSession(){
  const s = loadSession();
  if(s && s.login) setCurrentUserByLogin(s.login);
  else setCurrentUserByLogin(null);
})();

/* ================== –ò–ö–û–ù–ö–ò –ü–û –£–†–û–í–ù–Æ ================== */
function makeIconForClicks(c){
  const stage = Math.min(9, Math.floor(c/100));
  // –ø—Ä–æ—Å—Ç–∞—è –ø–∞–ª–∏—Ç—Ä–∞ + label
  const labels = ["0","100","200","300","400","500","600","700","800","900","1000+"];
  const colors = ["#0ea5a4","#3b82f6","#f97316","#e11d48","#8b5cf6","#06b6d4","#f59e0b","#10b981","#ef4444","#0ea5a4"];
  const bg = colors[stage%colors.length];
  // –∏—Å–ø–æ–ª—å–∑—É–µ–º emoji + —á–∏—Å–ª–æ
  return `<div style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;color:white;">
    <div style="font-size:48px">${stage<MEDALS.length?MEDALS[stage].emoji:"üñ±Ô∏è"}</div>
    <div style="font-size:18px;margin-top:6px">${labels[stage]}</div>
  </div>`;
}

/* ================== –†–ï–ù–î–ï–† ================== */
function renderMarket(){
  marketEl.innerHTML = "";
  MEDALS.forEach(m=>{
    const div = document.createElement("div");
    div.className = "market-item";
    div.innerHTML = `<div style="font-size:20px">${m.emoji} <strong>${m.name}</strong></div>
      <div class="muted" style="margin-top:6px">${m.price} –∫–ª–∏–∫–æ–≤</div>
      <div style="margin-top:8px"><button class="small" data-buy="${m.name}">–ö—É–ø–∏—Ç—å</button></div>`;
    marketEl.appendChild(div);
  });
  // –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
  marketEl.querySelectorAll("button[data-buy]").forEach(b=>{
    b.onclick = ()=> buyMedal(b.getAttribute("data-buy"));
  });
}

function renderInventory(){
  inventoryEl.innerHTML = "";
  if(!currentUser){ inventoryEl.innerHTML = `<span class="muted">–í–æ–π–¥–∏—Ç–µ —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</span>`; return; }
  if(!currentUser.inventory || currentUser.inventory.length===0){
    inventoryEl.innerHTML = `<span class="muted">–ü—É—Å—Ç–æ</span>`; return;
  }
  currentUser.inventory.forEach((medal, idx)=>{
    const m = MEDALS.find(x=>x.name===medal) || {name:medal,emoji:"üéñÔ∏è"};
    const item = document.createElement("div");
    item.className = "inv-item";
    item.innerHTML = `<span style="font-size:18px">${m.emoji}</span><div style="min-width:90px">${m.name}</div>
      <div style="display:flex;gap:6px">
        <button class="small" data-equip="${idx}">${currentUser.equippedMedal===m.name?"–ù–∞–¥–µ—Ç–æ":"–ù–∞–¥–µ—Ç—å"}</button>
        <button class="small" data-remove="${idx}">–£–¥–∞–ª–∏—Ç—å</button>
      </div>`;
    inventoryEl.appendChild(item);
  });
  // handlers
  inventoryEl.querySelectorAll("button[data-equip]").forEach(b=>{
    b.onclick = ()=> {
      const i = Number(b.getAttribute("data-equip"));
      const medal = currentUser.inventory[i];
      if(currentUser.equippedMedal === medal) { currentUser.equippedMedal = null; } else { currentUser.equippedMedal = medal; }
      updateUser(currentUser); setCurrentUserByLogin(currentUser.login);
    };
  });
  inventoryEl.querySelectorAll("button[data-remove]").forEach(b=>{
    b.onclick = ()=> {
      const i = Number(b.getAttribute("data-remove"));
      const medal = currentUser.inventory.splice(i,1)[0];
      if(currentUser.equippedMedal === medal) currentUser.equippedMedal = null;
      updateUser(currentUser); setCurrentUserByLogin(currentUser.login);
    };
  });
}

function renderProfile(){
  profileNameEl.textContent = currentUser ? currentUser.login : "–ì–æ—Å—Ç—å";
  userInfoEl.textContent = currentUser ? `${currentUser.login}` : "–ù–µ –≤–æ—à–ª–∏";
  countEl.textContent = currentUser ? currentUser.clicks : 0;
  checkmarkEl.textContent = (currentUser && currentUser.hasCheck) ? "‚úîÔ∏è" : "";
  equippedEl.textContent = (currentUser && currentUser.equippedMedal) ? (MEDALS.find(m=>m.name===currentUser.equippedMedal)?.emoji || "üéñÔ∏è") : "";
  // icon
  clickBox.innerHTML = makeIconForClicks(currentUser ? currentUser.clicks : 0);
}

function renderLeaders(){
  const users = loadUsers().slice().sort((a,b)=> (b.clicks||0) - (a.clicks||0)).slice(0,20);
  leadersBody.innerHTML = "";
  users.forEach((u,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${i+1}</td><td>${escapeHtml(u.login)} ${u.hasCheck? "‚úîÔ∏è":""} ${u.equippedMedal? (MEDALS.find(m=>m.name===u.equippedMedal)?.emoji||"üéñÔ∏è") : ""}</td><td>${u.clicks||0}</td>`;
    leadersBody.appendChild(tr);
  });
}

function escapeHtml(s){ return String(s).replace(/[&<>\"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –∞–¥–º–∏–Ω–∫–µ */
function populateAdminUserSelect(){
  const users = loadUsers();
  adminUserSelect.innerHTML = "";
  users.forEach(u=>{
    const opt = document.createElement("option");
    opt.value = u.login; opt.textContent = `${u.login} (${u.clicks||0})`;
    adminUserSelect.appendChild(opt);
  });
  adminMedalSelect.innerHTML = "";
  MEDALS.forEach(m=>{
    const opt = document.createElement("option");
    opt.value = m.name; opt.textContent = `${m.emoji} ${m.name}`;
    adminMedalSelect.appendChild(opt);
  });
}

/* –æ–±—â–∏–π render */
function renderAll(){
  renderMarket();
  renderProfile();
  renderInventory();
  renderLeaders();
  populateAdminUserSelect();
}

/* ================== –î–ï–ô–°–¢–í–ò–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ================== */
clickBox.onclick = ()=>{
  if(!currentUser){ alert("–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –∫–ª–∏–∫–∞—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å."); return; }
  currentUser.clicks = (currentUser.clicks||0) + 1;
  updateUser(currentUser);
  setCurrentUserByLogin(currentUser.login);
};

btnAdd10.onclick = ()=>{
  if(!currentUser){ alert("–í–æ–π–¥–∏—Ç–µ."); return; }
  currentUser.clicks = (currentUser.clicks||0) + 10;
  updateUser(currentUser); setCurrentUserByLogin(currentUser.login);
};
btnReset.onclick = ()=>{
  if(!currentUser){ alert("–í–æ–π–¥–∏—Ç–µ."); return; }
  if(confirm("–°–±—Ä–æ—Å–∏—Ç—å –∫–ª–∏–∫–∏ –≤ –Ω–æ–ª—å?")){ currentUser.clicks = 0; updateUser(currentUser); setCurrentUserByLogin(currentUser.login); }
};
btnSave.onclick = ()=>{
  if(!currentUser){ alert("–í–æ–π–¥–∏—Ç–µ."); return; }
  updateUser(currentUser); alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ localStorage.");
};
btnUnequip.onclick = ()=>{
  if(!currentUser){ alert("–í–æ–π–¥–∏—Ç–µ."); return; }
  currentUser.equippedMedal = null; updateUser(currentUser); setCurrentUserByLogin(currentUser.login);
};

/* —ç–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç –ø—Ä–æ—Ñ–∏–ª—è (JSON) */
btnExport.onclick = ()=>{
  if(!currentUser){ alert("–í–æ–π–¥–∏—Ç–µ."); return; }
  const data = JSON.stringify(currentUser);
  navigator.clipboard?.writeText(data).then(()=> alert("–ü—Ä–æ—Ñ–∏–ª—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞ (JSON)."), ()=> alert("–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é:\n"+data));
};
btnImport.onclick = ()=>{
  const data = prompt("–í—Å—Ç–∞–≤—å—Ç–µ JSON –ø—Ä–æ—Ñ–∏–ª—è –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞:");
  if(!data) return;
  try{
    const obj = JSON.parse(data);
    if(!obj.login) throw new Error("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç");
    obj.pass = obj.pass || encodePass(prompt("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ (–ø–∞—Ä–æ–ª—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ —Ç–æ–º –≤–∏–¥–µ, –∫–æ—Ç–æ—Ä—ã–π –≤—ã –≤–≤–µ–¥—ë—Ç–µ):") || "");
    updateUser(obj);
    alert("–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω. –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏ –ø–æ–¥ —ç—Ç–∏–º –ª–æ–≥–∏–Ω–æ–º.");
    populateAdminUserSelect(); renderLeaders();
  }catch(e){ alert("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: "+e.message); }
};

/* ================== –†–´–ù–û–ö ================== */
function buyMedal(name){
  if(!currentUser){ alert("–í–æ–π–¥–∏—Ç–µ —á—Ç–æ–±—ã –ø–æ–∫—É–ø–∞—Ç—å."); return; }
  const item = MEDALS.find(m=>m.name===name);
  if(!item) return;
  if((currentUser.clicks||0) < item.price){ alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–ª–∏–∫–æ–≤."); return; }
  currentUser.clicks -= item.price;
  currentUser.inventory = currentUser.inventory || [];
  currentUser.inventory.push(item.name);
  updateUser(currentUser); setCurrentUserByLogin(currentUser.login);
  alert(`–ö—É–ø–ª–µ–Ω–æ: ${item.name}`);
}

/* ================== –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø (–õ–û–ö–ê–õ–¨–ù–ê–Ø) ================== */
btnAuth.onclick = ()=> { authPanel.style.display = (authPanel.style.display==="none" || authPanel.style.display==="") ? "block" : "none"; authMsg.textContent=""; };
closeAuthBtn.onclick = ()=> authPanel.style.display = "none";

doRegisterBtn.onclick = ()=>{
  const login = inpLogin.value.trim();
  const pass = inpPass.value;
  if(!login || !pass){ authMsg.textContent = "–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å."; return; }
  const users = loadUsers();
  if(users.find(u=>u.login===login)){ authMsg.textContent = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç."; return; }
  const user = { login, pass: encodePass(pass), clicks:0, inventory:[], equippedMedal:null, hasCheck:false };
  users.push(user); saveUsers(users);
  authMsg.textContent = "–°–æ–∑–¥–∞–Ω–æ. –í–æ–π–¥–∏—Ç–µ.";
  inpPass.value = "";
};

doLoginBtn.onclick = ()=>{
  const login = inpLogin.value.trim();
  const pass = inpPass.value;
  if(!login || !pass){ authMsg.textContent = "–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å."; return; }
  const user = findUser(login);
  if(!user){ authMsg.textContent = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω."; return; }
  if(decodePass(user.pass) !== pass){ authMsg.textContent = "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å."; return; }
  setCurrentUserByLogin(login);
  authPanel.style.display = "none";
  inpLogin.value = ""; inpPass.value = "";
  authMsg.textContent = "";
};

/* ================== –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨ (–ª–æ–∫–∞–ª—å–Ω–æ) ================== */
btnAdmin.onclick = ()=>{
  const pass = prompt("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞:");
  if(pass !== ADMIN_PASSWORD){ alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞."); return; }
  adminPanel.style.display = "block";
  populateAdminUserSelect();
};
adminClose.onclick = ()=> adminPanel.style.display = "none";

adminAddClicksBtn.onclick = ()=>{
  const target = adminUserSelect.value;
  const amount = Number(adminAmount.value) || 0;
  if(!target){ alert("–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"); return; }
  const user = findUser(target);
  if(!user) return;
  user.clicks = (user.clicks||0) + amount;
  updateUser(user); populateAdminUserSelect(); renderAll();
  alert(`–î–æ–±–∞–≤–ª–µ–Ω–æ ${amount} –∫–ª–∏–∫–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${target}`);
  adminAmount.value = "";
};

adminGiveMedalBtn.onclick = ()=>{
  const target = adminUserSelect.value; const medal = adminMedalSelect.value;
  if(!target){ alert("–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"); return; }
  const user = findUser(target);
  if(!user) return;
  user.inventory = user.inventory || [];
  user.inventory.push(medal);
  updateUser(user); renderAll(); alert(`–í—ã–¥–∞–Ω–∞ –º–µ–¥–∞–ª—å ${medal} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${target}`);
};

adminRemoveMedalBtn.onclick = ()=>{
  const target = adminUserSelect.value; const medal = adminMedalSelect.value;
  if(!target){ alert("–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"); return; }
  const user = findUser(target);
  if(!user) return;
  const i = (user.inventory||[]).indexOf(medal);
  if(i>=0) user.inventory.splice(i,1);
  if(user.equippedMedal === medal) user.equippedMedal = null;
  updateUser(user); renderAll(); alert(`–ó–∞–±—Ä–∞–Ω–∞ –º–µ–¥–∞–ª—å ${medal} —É ${target}`);
};

adminGiveCheckBtn.onclick = ()=>{
  const target = adminUserSelect.value; if(!target){ alert("–í—ã–±–µ—Ä–∏—Ç–µ"); return; }
  const user = findUser(target); if(!user) return;
  user.hasCheck = true; updateUser(user); renderAll(); alert(`–ì–∞–ª–æ—á–∫–∞ –≤—ã–¥–∞–Ω–∞ ${target}`);
};
adminRemoveCheckBtn.onclick = ()=>{
  const target = adminUserSelect.value; if(!target){ alert("–í—ã–±–µ—Ä–∏—Ç–µ"); return; }
  const user = findUser(target); if(!user) return;
  user.hasCheck = false; updateUser(user); renderAll(); alert(`–ì–∞–ª–æ—á–∫–∞ —Å–Ω—è—Ç–∞ —É ${target}`);
};

/* ================== HELPERS ================== */
function updateUser(u){
  updateUserInternal(u);
  saveUsers(loadUsers()); // ensure persisted
}
function updateUserInternal(u){
  const users = loadUsers();
  const idx = users.findIndex(x=>x.login===u.login);
  if(idx>=0) users[idx] = u; else users.push(u);
  saveUsers(users);
}

/* ================== START ================== */
renderAll();

/* –û–±–Ω–æ–≤–ª—è–µ–º UI –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏, —á—Ç–æ–±—ã –æ—Ç—Ä–∞–∑–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è */
setInterval(()=>{ 
  // –µ—Å–ª–∏ –µ—Å—Ç—å —Å–µ—Å—Å–∏—è, —Ä–µ-–∑–∞—Ä—è–¥–∏–º —Ç–µ–∫—É—â–µ–≥–æ –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ (–Ω—É–∂–Ω–æ, –µ—Å–ª–∏ admin –∏–∑–º–µ–Ω–∏–ª)
  const s = loadSession();
  if(s && s.login){
    const fresh = findUser(s.login);
    if(fresh) currentUser = fresh;
  }
  renderAll();
}, 800);

</script>
</body>
</html>
